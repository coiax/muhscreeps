var util=require("util"),task_manager=require("task_manager"),roleCow={name:"role.cow",parts:[[WORK,CARRY,MOVE],[WORK,WORK,CARRY,MOVE],[WORK,WORK,WORK,CARRY,MOVE,MOVE]],run:function(e,b){var a=Game.getObjectById(e.source_id);if(!a){b.say("Mooo!");var a=b.room.find(FIND_SOURCES),g={};a.forEach(function(a){g[a]=0});for(var c in Game.creeps){var f=Game.creeps[c];if(b.name!=f.name&&f.has_task_in_queue(module.exports.name)){var h=Game.getObjectById(f.memory.source_id);g[h]+=f.body_part_count(WORK)}}a=
_.sortBy(a,function(a){return g[a]});if(a=a[0])e.source_id=a.id}if(!a)return b.say("Moo..."),{outcome:"continue"};var d=util.memoryPosition(e.pasture_loc);d&&1!=d.getRangeTo(a)&&(b.say("Moo?"),d=e.pasture_loc=null);d||(c=a.pos.walkable_adjacent(),d=_.sample(c),b.memory.pasture_loc=d);if(!d.isEqualTo(b.pos)){if(d.isNearTo(b)&&((a=d.lookFor(FIND_CREEPS))&&a.forEach(function(a){a.has_task_in_queue(module.exports.name)?(e.source_id=null,e.pasture_loc=null):(b.say("Mooove"),a.add_task({type:"leave",pos:d}))}),
!e.pasture_loc))return{outcome:"continue"};b.moveTo(d);return{outcome:"continue"}}c=Game.getObjectById(e.output_container_id);c||(f=b.pos.findInRange(FIND_STRUCTURES,1,{filter:function(a){return a.structureType==STRUCTURE_CONTAINER}}),f.length&&(c=f[0],e.output_container_id=c.id));if(!c){c=b.pos.findInRange(FIND_CONSTRUCTION_SITES,1,filter=function(a){return a.structureType==STRUCTURE_CONTAINER});if(c.length)a=c[0];else return a=a.pos.getDirectionTo(b),a=b.pos.step(a).createConstructionSite(STRUCTURE_CONTAINER),
{outcome:"continue"};b.add_task({type:"construct",target_id:a.id,resupply:"harvest"});return{outcome:"continue"}}if(c&&1!=c.pos.getRangeTo(b))return e.output_container_id=null,{outcome:"continue"};a=b.harvest(a);a==OK?b.memory.no_driveby_repair=!0:a==ERR_NOT_ENOUGH_RESOURCES&&(b.memory.no_driveby_repair=!1);c.hits<c.hitsMax/2?b.repair(c):b.transfer(c,RESOURCE_ENERGY);return{outcome:"continue"}}};task_manager.register(roleCow.name,roleCow.run);module.exports=roleCow;
