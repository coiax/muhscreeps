var util=require("util");function memoryPosition(a){return a?new RoomPosition(a.x,a.y,a.roomName):null}
var roleCow={parts:[[WORK,CARRY,MOVE],[WORK,WORK,CARRY,MOVE],[WORK,WORK,WORK,CARRY,MOVE,MOVE]],run:function(a){var b=Game.getObjectById(a.memory.source_id);if(!b){a.say("l4s");var b=a.room.find(FIND_SOURCES),e={};b.forEach(function(a){e[a]=0});for(var c in Game.creeps){var d=Game.creeps[c];if(a.name!=d.name&&"cow"==d.memory.role){var f=Game.getObjectById(d.memory.source_id);e[f]++}}b=_.sortBy(b,function(a){return e[a]});if(b=b[0])a.memory.source_id=b.id}if(b){d=memoryPosition(a.memory.pasture_loc);
if(!d){var g=b.pos.non_wall_adjacent();for(c in Game.creeps)if(c!=a.name&&(d=Game.creeps[c],"cow"==d.memory.role&&(f=Game.getObjectById(d.memory.source_id),f==b))){var h=memoryPosition(d.memory.pasture_loc);_.remove(g,function(a){return h.isEqualTo(a)})}d=_.sample(g);a.memory.pasture_loc=d}d.is_wall()||1!=d.getRangeTo(b)?(a.say("!ploc"),a.memory.debug_bad_pasture_loc=d,a.memory.pasture_loc=null):d.isEqualTo(a.pos)?(c=Game.getObjectById(a.memory.output_container_id),c||(d=a.pos.findInRange(FIND_STRUCTURES,
1,{filter:function(a){return a.structureType==STRUCTURE_CONTAINER}}),d.length&&(c=d[0],a.memory.output_container_id=c.id)),c?c&&(c.structureType!=STRUCTURE_CONTAINER||1!=c.pos.getRangeTo(a))?(a.say("umm"),a.memory.output_container_id=null):(b=a.harvest(b),b==OK?a.memory.no_driveby_repair=!0:b==ERR_NOT_ENOUGH_RESOURCES&&(a.memory.no_driveby_repair=!1),c.hits<c.hitsMax/2?a.repair(c):a.transfer(c,RESOURCE_ENERGY)):(c=a.pos.findInRange(FIND_CONSTRUCTION_SITES,1,filter=function(a){return a.structureType==
STRUCTURE_CONTAINER}),c.length?(b=c[0],a.add_task({type:"construct",target_id:b.id,resupply:"harvest"})):(b=b.pos.getDirectionTo(a),b=a.pos.step(b).createConstructionSite(STRUCTURE_CONTAINER)))):a.moveTo(d)}else a.say("!?src")}};module.exports=roleCow;
