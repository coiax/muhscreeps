var util=require("util"),task_manager=require("task_manager"),roleCow={name:"role.cow",parts:[[WORK,CARRY,MOVE],[WORK,WORK,CARRY,MOVE],[WORK,WORK,WORK,CARRY,MOVE,MOVE]],run:function(e,a){var b=Game.getObjectById(e.source_id);if(!b){a.say("Mooo!");var b=a.room.find(FIND_SOURCES),g={};b.forEach(function(a){g[a]=0});for(var c in Game.creeps){var f=Game.creeps[c];if(a.name!=f.name&&f.has_task_in_queue(module.exports.name)){var h=Game.getObjectById(f.memory.source_id);g[h]+=f.body_part_count(WORK)}}b=
_.sortBy(b,function(a){return g[a]});if(b=b[0])e.source_id=b.id}if(!b)return a.say("Moo..."),{outcome:"continue"};var d=util.memoryPosition(e.pasture_loc);1!=d.getRangeTo(b)&&(a.say("Moo?"),d=e.pasture_loc=null);d||(c=b.pos.walkable_adjacent(),d=_.sample(c),a.memory.pasture_loc=d);if(!d.isEqualTo(a.pos))return d.isNearTo(a)&&d.lookFor(FIND_CREEPS).forEach(function(b){if(b.has_task_in_queue(module.exports.name))return e.source_id=null,e.pasture_loc=null,{outcome:"continue"};a.say("Mooove");b.add_task({type:"leave",
pos:d})}),a.moveTo(d),{outcome:"continue"};c=Game.getObjectById(e.output_container_id);c||(f=a.pos.findInRange(FIND_STRUCTURES,1,{filter:function(a){return a.structureType==STRUCTURE_CONTAINER}}),f.length&&(c=f[0],e.output_container_id=c.id));if(!c){c=a.pos.findInRange(FIND_CONSTRUCTION_SITES,1,filter=function(a){return a.structureType==STRUCTURE_CONTAINER});if(c.length)b=c[0];else return b=b.pos.getDirectionTo(a),b=a.pos.step(b).createConstructionSite(STRUCTURE_CONTAINER),{outcome:"continue"};a.add_task({type:"construct",
target_id:b.id,resupply:"harvest"});return{outcome:"continue"}}if(c&&1!=c.pos.getRangeTo(a))return e.output_container_id=null,{outcome:"continue"};b=a.harvest(b);b==OK?a.memory.no_driveby_repair=!0:b==ERR_NOT_ENOUGH_RESOURCES&&(a.memory.no_driveby_repair=!1);c.hits<c.hitsMax/2?a.repair(c):a.transfer(c,RESOURCE_ENERGY);return{outcome:"continue"}}};task_manager.register(roleCow.name,roleCow.run);module.exports=roleCow;
