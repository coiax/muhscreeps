var util=require("util"),task_manager=require("task_manager"),roleCow={name:"role.cow",parts:[[WORK,CARRY,MOVE],[WORK,WORK,CARRY,MOVE],[WORK,WORK,WORK,CARRY,MOVE,MOVE],[WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE],[WORK,WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE,MOVE],[WORK,WORK,WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE,MOVE]],run:function(d,a){var c=Game.getObjectById(d.source_id);if(!c){a.say("Mooo!");var b=a.room.find(FIND_SOURCES),g={};b.forEach(function(a){g[a]=0});for(var h in Game.creeps){var k=Game.creeps[h];
if(a.name!=k.name){var f=k.has_task_in_queue(module.exports.name);f&&(f=Game.getObjectById(f.source_id),g[f]+=k.body_part_count(WORK))}}b=_.sortBy(b,function(a){return g[a]});b.length&&(c=b[0],d.source_id=c.id)}if(!c)return a.say("Moo..."),{outcome:"continue"};var e=util.memoryPosition(d.pasture_loc);e&&1!=e.getRangeTo(c)&&(a.say("Moo?"),e=d.pasture_loc=null);e||(b=c.pos.walkable_adjacent(),e=_.sample(b),d.pasture_loc=e);if(!e)return a.say("...moo"),d.pasture_loc=null,d.source_id=null,{outcome:"continue"};
if(!e.isEqualTo(a.pos)){if(e.isNearTo(a)&&((c=e.lookFor(FIND_CREEPS))&&c.length&&c.forEach(function(b){b.has_task_in_queue(module.exports.name)?(d.source_id=null,d.pasture_loc=null):(a.say("Mooove"),b.add_task({type:"leave",pos:e}))}),!d.pasture_loc))return{outcome:"continue"};a.moveTo(e);return{outcome:"continue"}}b=Game.getObjectById(d.output_container_id);b||(h=a.pos.findInRange(FIND_STRUCTURES,1,{filter:function(a){return a.structureType==STRUCTURE_CONTAINER}}),h.length&&(b=h[0],d.output_container_id=
b.id));if(!b){b=a.pos.findInRange(FIND_CONSTRUCTION_SITES,1,filter=function(a){return a.structureType==STRUCTURE_CONTAINER});if(b.length)c=b[0];else return c=c.pos.getDirectionTo(a),c=a.pos.step(c).createConstructionSite(STRUCTURE_CONTAINER),{outcome:"continue"};a.add_task({type:"construct",target_id:c.id,resupply:"harvest"});return{outcome:"continue"}}if(b&&1<b.pos.getRangeTo(a))return d.output_container_id=null,{outcome:"continue"};c=a.harvest(c);c==OK?a.memory.no_driveby_repair=!0:c==ERR_NOT_ENOUGH_RESOURCES&&
(a.memory.no_driveby_repair=!1);b.hits<b.hitsMax?a.repair(b):a.transfer(b,RESOURCE_ENERGY);return{outcome:"continue"}}};task_manager.register(roleCow.name,roleCow.run);module.exports=roleCow;
