require("loaded_modules");var gc=require("gc"),cpu_tracker=require("cpu_tracker"),task_manager=require("task_manager"),util=require("util"),cpu_debug=util.cpu_debug;
module.exports.loop=function(){var c=Game.cpu.bucket;if(500>c)console.log("Bucket is at "+c+". Halting execution.");else if(c=cpu_tracker.start("internal","memory_decode"),Memory.config||(Memory.config={}),cpu_tracker.stop(c),"undefined"==typeof Memory.config.use_pathfinder&&(Memory.config.use_pathfinder=!1),"undefined"==typeof Memory.config.cpu_debug&&(Memory.config.cpu_debug=!1),"undefined"==typeof Memory.config.just_exit&&(Memory.config.just_exit=!1),PathFinder.use(Memory.config.use_pathfinder),
!Memory.config.just_exit){cpu_debug("Start mainloop");c=cpu_tracker.start("internal","gc");gc.gc();cpu_tracker.stop(c);var c=cpu_tracker.start("global","scouting"),a;for(a in Game.rooms)cpu_debug("Scouting "+a),Game.rooms[a].scout_room();cpu_tracker.stop(c);for(var d in Game.structures)if(a=Game.structures[d],a.isActive()){var c=a.get_memory(),f=a.structureType;cpu_debug("Running tasks for "+d+"("+f+")");if(!a.has_tasks())switch(f){case STRUCTURE_TOWER:a.add_task({type:"structure.tower"});break;case STRUCTURE_SPAWN:a.add_task({type:"structure.spawner"})}a.has_tasks()&&
task_manager.run_task_queue(a,c.task_queue)}for(var e in Game.creeps){var b=Game.creeps[e];cpu_debug("Running tasks for "+e);b.spawning||(b.room.find(FIND_DROPPED_ENERGY).forEach(function(a){b.pickup(a)}),b.carry.energy&&!b.memory.no_driveby_repair&&(d=b.pos.findInRange(FIND_STRUCTURES,3,{filter:function(a){return util.is_damaged&&a.is_type([STRUCTURE_ROAD,STRUCTURE_CONTAINER])}}),d=_.sortBy(d,_.property("hits")),d.length&&b.repair(d[0])),b.wants_renew()&&b.add_task({type:"renew"}),b.has_tasks()||
b.add_task({type:"taskless"}),task_manager.run_task_queue(b,b.memory.task_queue))}cpu_debug("Recording total CPU usage.");cpu_tracker.record_main();e=cpu_tracker.start("internal","gc");gc.gc();cpu_tracker.stop(e);cpu_debug("Main loop complete.");cpu_tracker.calculate()}};
