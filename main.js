var genericActions=require("genericactions"),roleHarvester=require("role.harvester"),roleUpgrader=require("role.upgrader"),roleBuilder=require("role.builder"),roleCow=require("role.cow"),roleGuard=require("role.guard"),roleTower=require("role.tower"),mother=require("mother"),util=require("util");
module.exports.loop=function(){util.cpulog("+++");util.cpulog("Starting tick "+Game.time);util.cpulog("---");mother.run();"undefined"==typeof Memory.structures&&(Memory.structures={});"undefined"==typeof Memory.cpu_use&&(Memory.cpu_use=[]);for(var c in Memory.structures)Game.structures[c]||delete Memory.structures[c];for(c in Game.structures){var d=Game.structures[c];if(d.isActive()){var b=d.getMemory(),f=d.structureType;b.type=f;(b=b.task_queue)&&util.run_task_queue(d,b);(!b||!b.length)&&f==STRUCTURE_TOWER&&
roleTower.run(d)}}for(var e in Game.creeps){var a=Game.creeps[e];if(!a.spawning&&(a.room.find(FIND_DROPPED_ENERGY).forEach(function(b){a.pickup(b)}),b=a.memory.task_queue,100>a.ticksToLive&&(a.memory.recharge&&(!b||b.length&&"renew"!=b[0].type))&&a.add_task({type:"renew"}),util.run_task_queue(a,b),!b||!b.length))c=a.memory.role,util.cpulog("Running role("+c+") for "+a),"harvester"==c&&roleHarvester.run(a),"upgrader"==c&&roleUpgrader.run(a),"builder"==c&&roleBuilder.run(a),"cow"==c&&roleCow.run(a),
"guard"==c&&roleGuard.run(a),util.cpulog("Done role("+c+") for "+a)}util.cpulog("---");util.cpulog("Ending tick "+Game.time);util.cpulog("+++");Memory.cpu_use.push({time:Game.time,use:Game.cpu.getUsed()});e=_.meanBy(Memory.cpu_use,_property("time"));Memory.avg_cpu=e;100<Memory.cpu_use.length&&Memory.cpu_use.splice(0,Memory.cpu_use.length-100)};
