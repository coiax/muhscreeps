require("prototype.creep");require("prototype.structure");require("prototype.room");require("prototype.roomposition");require("structure.tower");require("structure.spawner");var gc=require("gc"),cpu_tracker=require("cpu_tracker"),task_manager=require("task_manager"),roles=require("roles"),mother=require("mother"),util=require("util");function cpu_debug(c){Game.memory.cpu_debug&&console.log(Game.cpu.getUsed()+": "+c)}
module.exports.loop=function(){cpu_debug("Start mainloop");gc.gc();mother.run();for(var c in Game.rooms)cpu_debug("Scouting "+c),Game.rooms[c].scout_room();for(var d in Game.structures)if(c=Game.structures[d],c.isActive()){var b=c.getMemory(),e=c.structureType;cpu_debug("Running tasks for "+d+"("+e+")");b.type=e;b=b.task_queue;if(!b||!b.length)switch(e){case STRUCTURE_TOWER:c.add_task({type:"structure.tower"});break;case STRUCTURE_SPAWN:c.add_task({type:"structure.spawner"})}b.length&&task_manager.run_task_queue(c,
b)}for(var f in Game.creeps){var a=Game.creeps[f];cpu_debug("Running tasks for "+f);a.spawning||(a.memory.role&&(a.add_task({type:roles[a.memory.role].name}),a.memory.role=void 0),a.room.find(FIND_DROPPED_ENERGY).forEach(function(b){a.pickup(b)}),a.carry.energy&&!a.memory.no_driveby_repair&&(d=a.pos.findInRange(FIND_STRUCTURES,3,{filter:util.is_damaged}),a.repair(_.sample(d))),b=a.memory.task_queue,100>a.ticksToLive&&(a.memory.recharge&&(!b||b.length&&"renew"!=b[0].type))&&a.add_task({type:"renew"}),
task_manager.run_task_queue(a,b))}cpu_debug("Recording total CPU usage.");cpu_tracker.record_main();cpu_tracker.calculate()};
