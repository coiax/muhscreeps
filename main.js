var genericActions=require("genericactions"),roles=require("roles"),mother=require("mother"),util=require("util");
module.exports.loop=function(){for(var d in Game.rooms);mother.run();"undefined"==typeof Memory.structures&&(Memory.structures={});"undefined"==typeof Memory.cpu_use&&(Memory.cpu_use=[]);for(var e in Memory.structures)Game.structures[e]||delete Memory.structures[e];for(e in Game.structures)if(d=Game.structures[e],d.isActive()){var a=d.getMemory(),f=d.structureType;a.type=f;(a=a.task_queue)&&util.run_task_queue(d,a);(!a||!a.length)&&f==STRUCTURE_TOWER&&roles.tower.run(d)}for(var c in Game.creeps){var b=
Game.creeps[c];b.spawning||(b.room.find(FIND_DROPPED_ENERGY).forEach(function(a){b.pickup(a)}),b.carry.energy&&!b.memory.no_driveby_repair&&(e=b.pos.findInRange(FIND_STRUCTURES,3,{filter:util.is_damaged}),b.repair(_.sample(e))),a=b.memory.task_queue,100>b.ticksToLive&&(b.memory.recharge&&(!a||a.length&&"renew"!=a[0].type))&&b.add_task({type:"renew"}),util.run_task_queue(b,a),(!a||!a.length)&&roles[b.memory.role].run(b))}Memory.cpu_use.push({time:Game.time,use:Game.cpu.getUsed()});c=0;for(var g in Memory.cpu_use)c+=
Memory.cpu_use[g].use;c/=Memory.cpu_use.length;Memory.avg_cpu=c;100<Memory.cpu_use.length&&Memory.cpu_use.splice(0,Memory.cpu_use.length-100)};
